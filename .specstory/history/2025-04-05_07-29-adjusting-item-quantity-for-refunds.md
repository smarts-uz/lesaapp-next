<!-- Generated by SpecStory -->

# Adjusting Item Quantity for Refunds (2025-04-05 12:29:01)

_**User**_

When refunding set @schema.prisma @2.sql  item meta quantity to a lower value it should be negative number it 

---

_**Assistant**_



---

Yes, for WooCommerce refunds, the item meta quantity should be negative. This is correctly implemented in your code:

1. In your route.ts file:
```typescript
// For the refund item, qty and amount should be NEGATIVE
const negativeQty = -Math.abs(item.quantity);
const negativeAmount = -Math.abs(item.amount);

// Then used in the metadata:
{
  order_item_id: refundItem.order_item_id,
  meta_key: "_qty",
  meta_value: negativeQty.toString(),
},
```

2. In your SQL file:
```sql
INSERT INTO `wp_woocommerce_order_itemmeta` 
(`meta_id`, `order_item_id`, `meta_key`, `meta_value`) 
VALUES (1347, 104, '_qty', '-1');
```

The negative quantity in refunds represents items being "removed" from the order, while other metadata like `_restock_refunded_items` uses positive values since they represent actual quantities being added back to inventory.

---

_**User**_

then why is it not displaying in  woocommerce interface with negative values?

---

_**Assistant**_



---

WooCommerce intentionally displays refund quantities as positive values in the admin interface, even though they're stored as negative in the database. This is a UX decision to make refunds more readable for store admins.

The negative values in the database (`_qty` = -1) are correct and necessary for internal processing, but WooCommerce's display logic automatically converts these to positive values when showing refund details.

This behavior is by design - WooCommerce knows that refund items always represent quantities being removed from the order, so displaying positive numbers makes more sense from a user perspective (e.g., "Refunded 2 items" is more intuitive than "Refunded -2 items").

As long as your database values are negative (which they are), the refund is processed correctly in the system.

---

_**User**_

so what should I do to fix the issue for example when I make a postman refund I need to see correct implementation in woocommerce interface

---

_**Assistant**_



---

To ensure your API-generated refunds display correctly in the WooCommerce interface, check these implementation details:

1. Ensure you're adding the refund metadata properly:
   ```typescript
   await tx.wp_wc_orders_meta.createMany({
     data: [
       {
         order_id: refundOrderId,
         meta_key: "_refund_amount",
         meta_value: totalRefundAmount.toString(), // Positive value here
       },
       // Other metadata...
     ],
   });
   ```

2. Make sure you're creating parent-child relations correctly:
   - The refund order needs `parent_order_id` pointing to original order
   - The refund order must have type "shop_order_refund"
   - Order stats entries need the correct parent_id

3. For individual line items:
   - Verify `_refunded_item_id` points to original order item
   - Ensure refund line items have negative quantities and amounts
   - For bundled items, check parent-child relationships are maintained

4. Update the original order's metadata to reflect refund amounts:
   ```typescript
   // Add this after processing all items
   await tx.wp_wc_orders_meta.create({
     data: {
       order_id: BigInt(orderId),
       meta_key: "_refund_amount",
       meta_value: totalRefundAmount.toString(),
     },
   });
   ```

These relationships allow WooCommerce to properly link refunds to their original orders and display quantities/amounts correctly in the interface.

---



---

