<!-- Generated by SpecStory -->

# Refactoring Prisma Usage in Router (2025-04-06 09:30:46)

_**User**_

do the same with all remaining instances of prisma usage directly on the router file 

---

_**Assistant**_



---

<details>
            <summary>Searched codebase "services/refund.ts" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `services/refund/create/storeRefundMetadata.ts` | L5-54 |
| `types/pos.ts` | L141-156 |
| `services/refund/create/createRefundOrder.ts` | L13-62 |
| `types/pos.ts` | L164-176 |
| `services/refund/create/createRefundOrderItem.ts` | L67-123 |
| `services/refund/create/createRefundOrderStats.ts` | L10-67 |
| `services/refund/create/createRefundOrderItem.ts` | L123-167 |
| `services/refund/create/createRefundOrderItem.ts` | L28-67 |
| `services/refund/create/createRefundOrderItem.ts` | L15-22 |
| `.specstory/history/2025-04-06_04-18-exporting-prisma-functions-to-services.md` | L861-930 |
| `services/refund/create/index.ts` | L1-2 |
| `app/api/refund/route.ts` | L94-157 |
| `app/api/refund/route.ts` | L42-94 |
| `services/refund/create/updateOrderWithRentalCalculations.ts` | L5-40 |
| `services/refund/create/createRefundBundledItemMeta.ts` | L10-87 |
| `services/refund/create/processRefundBundledItems.ts` | L21-26 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L1393-1819 |
| `app/api/refund/route.ts` | L220-280 |
| `services/refund/create/createRefundBundledItem.ts` | L26-64 |
| `services/refund/create/index.ts` | L12-13 |
| `.specstory/history/2025-04-06_04-18-exporting-prisma-functions-to-services.md` | L930-1005 |
| `.specstory/history/2025-04-06_04-18-exporting-prisma-functions-to-services.md` | L1005-1140 |
| `app/api/refund/route.ts` | L1-24 |
| `types/pos.ts` | L156-164 |
| `app/api/refund/route.ts` | L157-220 |

</details>

---

Let me search for the remaining service files to see what's already been implemented.

---

<details>
            <summary>Searched codebase "services/refund update stock reset bundled" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `services/refund/create/createRefundBundledItem.ts` | L125-165 |
| `services/refund/create/updateProductStock.ts` | L27-100 |
| `services/refund/create/processRefundBundledItems.ts` | L31-106 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L3119-3251 |
| `.specstory/history/2025-04-05_07-11-code-analysis-and-refund-fix.md` | L195-242 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L3026-3119 |
| `services/refund/create/createRefundBundledItemMeta.ts` | L10-87 |
| `.specstory/history/2025-04-05_06-43-creating-a-refund-post-route.md` | L1182-1242 |
| `services/refund/create/createRefundBundledItem.ts` | L26-64 |
| `services/refund/create/createRefundBundledItem.ts` | L64-125 |
| `.specstory/history/2025-04-05_06-43-creating-a-refund-post-route.md` | L1279-1332 |
| `services/order/create/updateProductStock.ts` | L47-78 |
| `services/refund/create/updateProductStock.ts` | L23-27 |
| `.specstory/history/2025-04-05_11-58-refund-process-product-lookup-modification.md` | L65-115 |
| `.specstory/history/2025-04-05_06-43-creating-a-refund-post-route.md` | L1332-1411 |
| `app/api/refund/route.ts` | L220-280 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L2762-2960 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L1393-1819 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L2546-2629 |
| `services/refund/create/processRefundBundledItems.ts` | L15-21 |
| `.specstory/history/2025-04-05_10-06-integrating-rental-pricing-in-refund-logic.md` | L191-236 |
| `.specstory/history/2025-04-05_07-35-refund-process-and-stock-management-issues.md` | L63-139 |
| `.specstory/history/2025-04-06_04-18-exporting-prisma-functions-to-services.md` | L1140-1186 |
| `.specstory/history/2025-04-05_07-16-prisma-api-for-refund-queries.md` | L65-133 |
| `.specstory/history/2025-04-05_06-43-creating-a-refund-post-route.md` | L1242-1279 |

</details>

---

Let me check for any existing services related to updating order status and operational data.

---

<details>
            <summary>Searched codebase "services/refund update order status reset stock flags operational data" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `.specstory/history/2025-04-05_06-43-creating-a-refund-post-route.md` | L1332-1411 |
| `.specstory/history/2025-04-05_07-16-prisma-api-for-refund-queries.md` | L537-639 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L1819-1953 |
| `.specstory/history/2025-04-05_06-43-creating-a-refund-post-route.md` | L1133-1182 |
| `services/refund/create/updateProductStock.ts` | L27-100 |
| `services/refund/create/createRefundOrderStats.ts` | L10-67 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L1393-1819 |
| `.specstory/history/2025-04-05_07-11-code-analysis-and-refund-fix.md` | L242-306 |
| `services/refund/create/createRefundOrderItem.ts` | L123-167 |
| `.specstory/history/2025-04-05_07-16-prisma-api-for-refund-queries.md` | L189-537 |
| `app/api/refund/route.ts` | L280-326 |
| `app/api/refund/route.ts` | L157-220 |
| `services/refund/create/createRefundBundledItem.ts` | L125-165 |
| `.specstory/history/2025-04-05_07-35-refund-process-and-stock-management-issues.md` | L63-139 |
| `services/refund/create/updateOrderWithRentalCalculations.ts` | L5-40 |
| `.specstory/history/2025-04-05_07-11-code-analysis-and-refund-fix.md` | L306-367 |
| `.specstory/history/2025-04-06_04-18-exporting-prisma-functions-to-services.md` | L1140-1186 |
| `.specstory/history/2025-04-06_04-18-exporting-prisma-functions-to-services.md` | L1005-1140 |
| `services/refund/create/createRefundOrderItem.ts` | L67-123 |
| `app/api/refund/route.ts` | L220-280 |
| `.specstory/history/2025-04-05_07-11-code-analysis-and-refund-fix.md` | L195-242 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L3026-3119 |
| `.specstory/history/2025-04-05_06-43-creating-a-refund-post-route.md` | L1182-1242 |
| `.specstory/history/2025-04-05_11-58-refund-process-product-lookup-modification.md` | L65-115 |
| `.specstory/history/2025-04-05_07-16-prisma-api-for-refund-queries.md` | L133-189 |

</details>

---

Now, let me search specifically for functions that might handle resetting stock flags and creating operational data.

---

<details>
            <summary>Searched codebase "createRefundOperationalData resetReducedStockFlags updateOrderStatus" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `.specstory/history/2025-04-05_06-43-creating-a-refund-post-route.md` | L1332-1411 |
| `.specstory/history/2025-04-05_07-16-prisma-api-for-refund-queries.md` | L537-639 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L1819-1953 |
| `.specstory/history/2025-04-05_07-11-code-analysis-and-refund-fix.md` | L242-306 |
| `app/api/refund/route.ts` | L280-326 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L1393-1819 |
| `.specstory/history/2025-04-05_06-43-creating-a-refund-post-route.md` | L1133-1182 |
| `services/refund/create/createRefundOrderStats.ts` | L10-67 |
| `services/refund/create/createRefundOrderItem.ts` | L123-167 |
| `.specstory/history/2025-04-05_07-16-prisma-api-for-refund-queries.md` | L189-537 |
| `.specstory/history/2025-04-05_07-11-code-analysis-and-refund-fix.md` | L306-367 |
| `services/refund/create/updateProductStock.ts` | L27-100 |
| `.specstory/history/2025-04-06_04-18-exporting-prisma-functions-to-services.md` | L1005-1140 |
| `.specstory/history/2025-04-06_04-18-exporting-prisma-functions-to-services.md` | L1140-1186 |
| `.specstory/history/2025-04-05_07-35-refund-process-and-stock-management-issues.md` | L63-139 |
| `services/refund/create/createRefundBundledItem.ts` | L125-165 |
| `.specstory/history/2025-04-05_11-58-refund-process-product-lookup-modification.md` | L65-115 |
| `.specstory/history/2025-04-05_10-06-integrating-rental-pricing-in-refund-logic.md` | L86-147 |
| `services/refund/create/createRefundOrderItem.ts` | L67-123 |
| `app/api/refund/route.ts` | L157-220 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L1335-1393 |
| `.specstory/history/2025-04-05_10-25-refund-calculation-fields-update.md` | L3026-3119 |
| `app/api/refund/route.ts` | L220-280 |
| `types/pos.ts` | L164-176 |
| `.specstory/history/2025-04-06_04-18-exporting-prisma-functions-to-services.md` | L861-930 |

</details>

---

Now, I'm ready to create the necessary service functions and refactor the route handler.

---

<details>
            <summary>Searched codebase "TransactionClient" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `services/refund/create/createRefundOrderStats.ts` | L1-6 |
| `services/refund/create/createRefundOrder.ts` | L1-5 |
| `services/refund/create/updateProductStock.ts` | L1-18 |
| `services/refund/create/findOrderById.ts` | L1-5 |
| `services/refund/create/createRefundOrderItem.ts` | L1-15 |
| `services/order/create/createOrderStats.ts` | L1-5 |
| `services/refund/create/createRefundBundledItem.ts` | L1-15 |
| `services/refund/create/updateOrderWithRentalCalculations.ts` | L1-5 |
| `services/order/create/createOrderProductLookup.ts` | L1-5 |
| `services/refund/create/processRefundBundledItems.ts` | L1-15 |
| `services/refund/create/storeRefundMetadata.ts` | L1-5 |
| `services/refund/create/addRefundComment.ts` | L1-5 |
| `services/order/create/createOperationalData.ts` | L1-5 |
| `services/order/create/updateProductStock.ts` | L1-5 |
| `services/order/create/createOrderItem.ts` | L1-5 |
| `services/order/create/createBillingAddress.ts` | L12-18 |
| `services/refund/create/createRefundBundledItemMeta.ts` | L1-5 |
| `services/order/create/createOrderItemMetaEntries.ts` | L1-7 |
| `services/order/create/createBundledItemMeta.ts` | L1-7 |
| `services/refund/create/findOrderById.ts` | L9-37 |
| `.specstory/history/2025-04-06_04-18-exporting-prisma-functions-to-services.md` | L571-807 |
| `.specstory/history/2025-04-05_19-19-update-createorderrecord-function.md` | L59-121 |
| `services/refund/create/createRefundOrder.ts` | L13-62 |
| `services/order/create/createOrderStats.ts` | L13-48 |
| `.specstory/history/2025-04-05_19-33-create-helper-function-for-order.md` | L1210-1309 |

</details>

---

Now I'll create the necessary service functions to refactor the remaining direct Prisma calls in the route.ts file.

---

<details>
            <summary>Listed directory services/refund • **3** results</summary>
        
| Name |
|-------|
| 📁 `create` |
| 📄 `index.ts` |
| 📁 `fetch` |

</details>

---

<details>
            <summary>Listed directory services/refund/create • **13** results</summary>
        
| Name |
|-------|
| 📄 `index.ts` |
| 📄 `processRefundBundledItems.ts` |
| 📄 `createRefundBundledItem.ts` |
| 📄 `createRefundBundledItemMeta.ts` |
| 📄 `createRefundOrderItem.ts` |
| 📄 `addRefundComment.ts` |
| 📄 `updateProductStock.ts` |
| 📄 `createRefundOrderStats.ts` |
| 📄 `storeRefundMetadata.ts` |
| 📄 `createRefundOrder.ts` |
| 📄 `calculateRentalPrice.ts` |
| 📄 `updateOrderWithRentalCalculations.ts` |
| 📄 `findOrderById.ts` |

</details>

---

Read file: services/refund/create/index.ts

---

Read file: services/refund/index.ts

---

Now I'll create the necessary service functions for the remaining direct Prisma calls in the route handler.

---

```diff
- 
+ interface TransactionClient {
+   wp_wc_orders: {
+     update: Function;
+   };
+ }
+ 
+ interface UpdateOrderStatusParams {
+   tx: TransactionClient;
+   orderId: number | string;
+   status: string;
+ }
+ 
+ /**
+  * Updates an order's status and timestamp
+  */
+ export async function updateOrderStatus({
+   tx,
+   orderId,
+   status,
+ }: UpdateOrderStatusParams) {
+   return await tx.wp_wc_orders.update({
+     where: {
+       id: BigInt(orderId),
+     },
+     data: {
+       status,
+       date_updated_gmt: new Date(),
+     },
+   });
+ } 
```

---

```diff
- 
+ interface TransactionClient {
+   wp_wc_orders: {
+     update: Function;
+   };
+ }
+ 
+ interface UpdateOrderTimestampParams {
+   tx: TransactionClient;
+   orderId: number | string;
+ }
+ 
+ /**
+  * Updates an order's timestamp without changing status
+  */
+ export async function updateOrderTimestamp({
+   tx,
+   orderId,
+ }: UpdateOrderTimestampParams) {
+   return await tx.wp_wc_orders.update({
+     where: {
+       id: BigInt(orderId),
+     },
+     data: {
+       date_updated_gmt: new Date(),
+     },
+   });
+ } 
```

---

```diff
- 
+ interface TransactionClient {
+   wp_woocommerce_order_itemmeta: {
+     updateMany: Function;
+   };
+ }
+ 
+ interface ResetReducedStockFlagsParams {
+   tx: TransactionClient;
+   itemId: number;
+ }
+ 
+ /**
+  * Resets the reduced stock flags for an order item
+  */
+ export async function resetReducedStockFlags({
+   tx,
+   itemId,
+ }: ResetReducedStockFlagsParams) {
+   return await tx.wp_woocommerce_order_itemmeta.updateMany({
+     where: {
+       order_item_id: BigInt(itemId),
+       meta_key: "_reduced_stock",
+     },
+     data: {
+       meta_value: "0",
+     },
+   });
+ } 
```

---

```diff
- 
+ interface TransactionClient {
+   wp_wc_order_operational_data: {
+     create: Function;
+   };
+ }
+ 
+ interface CreateRefundOperationalDataParams {
+   tx: TransactionClient;
+   refundOrderId: bigint;
+ }
+ 
+ /**
+  * Creates operational data for a refund order
+  */
+ export async function createRefundOperationalData({
+   tx,
+   refundOrderId,
+ }: CreateRefundOperationalDataParams) {
+   try {
+     return await tx.wp_wc_order_operational_data.create({
+       data: {
+         order_id: refundOrderId,
+         created_via: "api",
+         woocommerce_version: "9.7.1",
+         prices_include_tax: false,
+         coupon_usages_are_counted: null,
+         download_permission_granted: null,
+         cart_hash: null,
+         new_order_email_sent: null,
+         order_key: null,
+         order_stock_reduced: null,
+         date_paid_gmt: null,
+         date_completed_gmt: null,
+         shipping_tax_amount: 0,
+         shipping_total_amount: 0,
+         discount_tax_amount: 0,
+         discount_total_amount: 0,
+         recorded_sales: false,
+       },
+     });
+   } catch (error) {
+     // Optional table, continue if it doesn't exist
+     console.warn(
+       "Order operational data could not be created, continuing with refund process"
+     );
+     return null;
+   }
+ } 
```

---

```diff
  export { createRefundBundledItem } from './createRefundBundledItem';
  export { processRefundBundledItems } from './processRefundBundledItems';
+ export { updateOrderStatus } from './updateOrderStatus';
+ export { updateOrderTimestamp } from './updateOrderTimestamp';
+ export { resetReducedStockFlags } from './resetReducedStockFlags';
+ export { createRefundOperationalData } from './createRefundOperationalData'; 
```

---

Now that I've created the necessary service functions, I'll refactor the route.ts file to use these functions:

---

```diff
    updateProductStock,
    addRefundComment,
-   processRefundBundledItems
+   processRefundBundledItems,
+   updateOrderStatus,
+   updateOrderTimestamp,
+   resetReducedStockFlags,
+   createRefundOperationalData
  } from "@/services/refund";
  
          // Only update the original order status to refunded if it's a full refund
          if (refundType === "full") {
-           await tx.wp_wc_orders.update({
-             where: {
-               id: BigInt(orderId),
-             },
-             data: {
-               status: "wc-refunded",
-               date_updated_gmt: now,
-             },
+           await updateOrderStatus({
+             tx,
+             orderId,
+             status: "wc-refunded"
            });
          } else {
            // For partial refunds, just update the date_updated_gmt
-           await tx.wp_wc_orders.update({
-             where: {
-               id: BigInt(orderId),
-             },
-             data: {
-               date_updated_gmt: now,
-             },
+           await updateOrderTimestamp({
+             tx,
+             orderId
            });
          }
          // Reset reduced stock flags for original order items
          for (const item of items) {
-           await tx.wp_woocommerce_order_itemmeta.updateMany({
-             where: {
-               order_item_id: BigInt(item.itemId),
-               meta_key: "_reduced_stock",
-             },
-             data: {
-               meta_value: "0",
-             },
+           await resetReducedStockFlags({
+             tx,
+             itemId: item.itemId
            });
  
            // Handle bundled items too
            if (item.isBundle && item.bundledItems) {
              for (const bundledItem of item.bundledItems) {
-               await tx.wp_woocommerce_order_itemmeta.updateMany({
-                 where: {
-                   order_item_id: BigInt(bundledItem.itemId),
-                   meta_key: "_reduced_stock",
-                 },
-                 data: {
-                   meta_value: "0",
-                 },
+               await resetReducedStockFlags({
+                 tx,
+                 itemId: bundledItem.itemId
                });
              }
          // Update order operational data if it exists
          try {
-           await tx.wp_wc_order_operational_data.create({
-             data: {
-               order_id: refundOrderId,
-               created_via: "api",
-               woocommerce_version: "9.7.1",
-               prices_include_tax: false,
-               coupon_usages_are_counted: null,
-               download_permission_granted: null,
-               cart_hash: null,
-               new_order_email_sent: null,
-               order_key: null,
-               order_stock_reduced: null,
-               date_paid_gmt: null,
-               date_completed_gmt: null,
-               shipping_tax_amount: 0,
-               shipping_total_amount: 0,
-               discount_tax_amount: 0,
-               discount_total_amount: 0,
-               recorded_sales: false,
-             },
+           await createRefundOperationalData({
+             tx,
+             refundOrderId
            });
          } catch (error) {
```

---

Great! I've successfully refactored all direct Prisma usage from the router file to appropriate service functions. Here's a summary of what I did:

1. Created new service functions in the `services/refund/create` directory:
   - `updateOrderStatus.ts` - For updating an order's status to refunded
   - `updateOrderTimestamp.ts` - For updating just the timestamp for partial refunds
   - `resetReducedStockFlags.ts` - For resetting the stock flag values in order items
   - `createRefundOperationalData.ts` - For creating the operational data for refund orders

2. Updated the exports in `services/refund/create/index.ts` to include the new service functions

3. Modified `app/api/refund/route.ts` to:
   - Import the new service functions
   - Replace direct Prisma calls with calls to the service functions

All Prisma usage has now been moved to the service layer, making the code more maintainable and testable while following the application's architecture pattern.

---



---

