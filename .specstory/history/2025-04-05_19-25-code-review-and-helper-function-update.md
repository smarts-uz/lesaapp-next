<!-- Generated by SpecStory -->

# Code Review and Helper Function Update (2025-04-06 00:25:52)

_**User**_

Analyze the code and check if there is not a helper function for a request create it & if there is update it with newest query and use it 

---

_**Assistant**_



---

<details>
            <summary>Searched codebase "function for creating orders in services/order" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `services/order/create/index.ts` | L1-2 |
| `services/order/create/createOrderRecord.ts` | L1-14 |
| `services/order/create/createOrderItem.ts` | L10-28 |
| `services/order/create/index.ts` | L34-43 |
| `services/order/create/createOrderRecord.ts` | L14-50 |
| `services/order/create/createOrderItemMeta.ts` | L6-62 |
| `services/order/fetch/fetchOrders.ts` | L109-153 |
| `services/order/create/createOrderItemMeta.ts` | L1-6 |
| `services/order/create/index.ts` | L9-23 |
| `services/order/create/createOrderItem.ts` | L1-5 |
| `.specstory/history/2025-04-05_14-35-function-duplication-request.md` | L533-638 |
| `services/order/fetch/fetchOrders.ts` | L14-30 |
| `services/order/create/createBundleItem.ts` | L1-11 |
| `services/order/create/createOperationalData.ts` | L5-33 |
| `app/api/order/route.ts` | L106-140 |
| `services/order/create/index.ts` | L4-5 |
| `services/order/fetch/fetchOrders.ts` | L30-40 |
| `app/api/order/route.ts` | L1-25 |
| `app/api/order/route.ts` | L74-106 |
| `.specstory/history/2025-04-05_04-48-create-post-route-for-order-creation.md` | L1-205 |
| `services/order/create/createOrderItem.ts` | L5-10 |
| `services/order/create/updateProductStock.ts` | L5-11 |
| `.specstory/history/2025-04-04_14-19-prisma-api-for-woocommerce-orders.md` | L160-227 |
| `services/order/fetch/fetchOrders.ts` | L69-109 |
| `services/order/create/createBundleItem.ts` | L11-16 |

</details>

---

<details>
            <summary>Searched codebase "createOrder.ts" • **4** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

Based on my analysis, there isn't a comprehensive helper function that encapsulates the entire order creation process. The current implementation has multiple smaller helper functions for specific parts of the order creation process, but the main logic is directly in the route handler.

I'll create a new helper function called `createOrder` that will handle the entire order creation process, making the API route much cleaner.

---

```diff
- 
+ import { PrismaClient } from "@prisma/client";
+ import {
+   createOrderRecord,
+   createBillingAddress,
+   createOperationalData,
+   createOrderItem,
+   generateOrderItemMeta,
+   generateBundleProductMeta,
+   updateProductStock,
+   ProductItem,
+   OrderCreateParams,
+   createOrderProductLookup,
+ } from "./index";
+ 
+ // Define a transaction interface for type safety
+ interface PrismaTransaction {
+   wp_wc_orders: {
+     create: Function;
+   };
+   wp_wc_order_addresses: {
+     create: Function;
+   };
+   wp_wc_order_operational_data: {
+     create: Function;
+   };
+   wp_woocommerce_order_items: {
+     create: Function;
+   };
+   wp_woocommerce_order_itemmeta: {
+     createMany: Function;
+   };
+   wp_wc_product_meta_lookup: {
+     upsert: Function;
+   };
+   wp_wc_order_product_lookup: {
+     create: Function;
+   };
+   wp_wc_order_stats: {
+     create: Function;
+   };
+ }
+ 
+ interface CreateOrderOptions {
+   ipAddress: string;
+   userAgent: string;
+ }
+ 
+ export async function createOrder(
+   body: OrderCreateParams,
+   options: CreateOrderOptions,
+   prisma: PrismaClient
+ ) {
+   const {
+     customer,
+     products,
+     status = "wc-processing",
+     paymentMethod = "cod",
+     paymentMethodTitle = "Cash on delivery",
+     start_date,
+   } = body;
+ 
+   if (!products || !Array.isArray(products) || products.length === 0) {
+     throw new Error("Products are required");
+   }
+ 
+   if (!start_date) {
+     throw new Error("start_date is required");
+   }
+ 
+   // Calculate total amount from products
+   const totalAmount = products.reduce(
+     (total, product: ProductItem) => total + product.price * product.quantity,
+     0
+   );
+ 
+   // Create order using Prisma transaction
+   return await prisma.$transaction(async (tx: PrismaTransaction) => {
+     // 1. Create the main order record
+     const order = await createOrderRecord({
+       tx,
+       customerId: customer?.id,
+       email: customer?.email,
+       status,
+       totalAmount,
+       paymentMethod,
+       paymentMethodTitle,
+       ipAddress: options.ipAddress,
+       userAgent: options.userAgent,
+       startDate: start_date,
+     });
+ 
+     // 2. Create billing address if customer info is provided
+     if (customer) {
+       await createBillingAddress({
+         tx,
+         customer,
+         orderId: order.id,
+       });
+     }
+ 
+     // 3. Create operational data
+     await createOperationalData({
+       tx,
+       orderId: order.id,
+     });
+ 
+     // Calculate total items for order stats
+     let totalItemsCount = 0;
+ 
+     // 4. Create order items and handle bundles
+     for (const product of products) {
+       // Create order item
+       const orderItem = await createOrderItem({
+         tx,
+         orderId: order.id,
+         product,
+       });
+ 
+       // Generate base order item meta
+       const baseItemMeta = generateOrderItemMeta({
+         orderItemId: orderItem.order_item_id,
+         product,
+       });
+ 
+       // Add entry to wp_wc_order_product_lookup for main product
+       await createOrderProductLookup({
+         tx,
+         orderItemId: orderItem.order_item_id,
+         orderId: order.id,
+         product,
+         customer,
+       });
+ 
+       totalItemsCount += product.quantity;
+ 
+       // If this is a bundle product, add bundle-specific meta
+       if (product.isBundle && product.bundleItems) {
+         const bundleCartKey = Math.random().toString(36).substring(2, 15);
+         const bundledItemsKeys = product.bundleItems.map(() =>
+           Math.random().toString(36).substring(2, 15)
+         );
+ 
+         // Add bundle meta
+         const bundleMeta = generateBundleProductMeta({
+           orderItemId: orderItem.order_item_id,
+           bundleCartKey,
+           bundledItemsKeys,
+         });
+ 
+         baseItemMeta.push(...bundleMeta);
+ 
+         // Create bundled items
+         for (const [index, bundleItem] of product.bundleItems.entries()) {
+           const bundledOrderItem = await tx.wp_woocommerce_order_items.create(
+             {
+               data: {
+                 order_item_name: `Product #${bundleItem.product_id}`,
+                 order_item_type: "line_item",
+                 order_id: order.id,
+               },
+             }
+           );
+ 
+           // Add bundled item meta
+           await tx.wp_woocommerce_order_itemmeta.createMany({
+             data: [
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_product_id",
+                 meta_value: bundleItem.product_id.toString(),
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_variation_id",
+                 meta_value: "0",
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_qty",
+                 meta_value: bundleItem.quantity.toString(),
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_tax_class",
+                 meta_value: "",
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_line_subtotal",
+                 meta_value: "0",
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_line_subtotal_tax",
+                 meta_value: "0",
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_line_total",
+                 meta_value: "0",
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_line_tax",
+                 meta_value: "0",
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_line_tax_data",
+                 meta_value: 'a:2:{s:5:"total";a:0:{}s:8:"subtotal";a:0:{}}',
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_bundled_by",
+                 meta_value: bundleCartKey,
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_bundled_item_id",
+                 meta_value: (index + 1).toString(),
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_bundled_item_priced_individually",
+                 meta_value: "no",
+               },
+               {
+                 order_item_id: bundledOrderItem.order_item_id,
+                 meta_key: "_bundled_item_needs_shipping",
+                 meta_value: "yes",
+               },
+             ],
+           });
+ 
+           // Add entry to wp_wc_order_product_lookup for bundled item
+           await createOrderProductLookup({
+             tx,
+             orderItemId: bundledOrderItem.order_item_id,
+             orderId: order.id,
+             product: {
+               product_id: bundleItem.product_id,
+               quantity: bundleItem.quantity,
+               price: 0, // Bundled items typically have 0 price
+             },
+             customer,
+           });
+ 
+           totalItemsCount += bundleItem.quantity;
+ 
+           // Update stock for bundled item
+           await tx.wp_wc_product_meta_lookup.upsert({
+             where: {
+               product_id: BigInt(bundleItem.product_id),
+             },
+             create: {
+               product_id: BigInt(bundleItem.product_id),
+               stock_quantity: -bundleItem.quantity,
+               total_sales: bundleItem.quantity,
+               min_price: 0,
+               max_price: 0,
+               rating_count: 0,
+               average_rating: 0,
+             },
+             update: {
+               stock_quantity: {
+                 decrement: bundleItem.quantity,
+               },
+               total_sales: {
+                 increment: bundleItem.quantity,
+               },
+             },
+           });
+         }
+       }
+ 
+       // Create order item meta
+       await tx.wp_woocommerce_order_itemmeta.createMany({
+         data: baseItemMeta,
+       });
+ 
+       // Update product stock if not a bundle
+       if (!product.isBundle) {
+         await updateProductStock({
+           tx,
+           product,
+         });
+       }
+     }
+ 
+     // 5. Create order stats entry
+     try {
+       await tx.wp_wc_order_stats.create({
+         data: {
+           order_id: order.id,
+           parent_id: BigInt(0),
+           date_created: new Date(),
+           date_created_gmt: new Date(),
+           num_items_sold: totalItemsCount,
+           total_sales: totalAmount,
+           tax_total: 0,
+           shipping_total: 0,
+           net_total: totalAmount,
+           returning_customer: false,
+           status: status,
+           customer_id: customer?.id ? BigInt(customer.id) : BigInt(0),
+         },
+       });
+     } catch (error) {
+       console.warn("Failed to create order stats:", error);
+       // Continue processing as this is not critical
+     }
+ 
+     return {
+       id: order.id.toString(),
+       number: `#ORD-${order.id.toString().padStart(3, "0")}`,
+       date: order.date_created_gmt?.toISOString(),
+       customer: customer
+         ? `${customer.firstName || ""} ${customer.lastName || ""}`
+         : "Guest",
+       status: order.status,
+       total: Number(order.total_amount) || 0,
+     };
+   });
+ } 
```

---

```diff
  export { updateProductStock } from './updateProductStock';
  export { createOrderProductLookup } from './createOrderProductLookup';
+ export { createOrder } from './createOrder';
  
  // Define common interfaces
```

---

```diff
  import { prisma } from "@/lib/prisma";
  import {
-   createOrderRecord,
-   createBillingAddress,
-   createOperationalData,
-   createOrderItem,
-   generateOrderItemMeta,
-   generateBundleProductMeta,
-   createBundleItem,
-   updateProductStock,
-   ProductItem,
+   createOrder,
    OrderCreateParams,
-   createOrderProductLookup,
  } from "@/services/order/create";
  import { fetchOrders } from "@/services/order/fetch";
  // Initialize BigInt serializer
  bigIntSerializer();
- 
- interface PrismaTransaction {
-   wp_wc_orders: {
-     create: Function;
-   };
-   wp_wc_order_addresses: {
-     create: Function;
-   };
-   wp_wc_order_operational_data: {
-     create: Function;
-   };
-   wp_woocommerce_order_items: {
-     create: Function;
-   };
-   wp_woocommerce_order_itemmeta: {
-     createMany: Function;
-   };
-   wp_wc_product_meta_lookup: {
-     upsert: Function;
-   };
-   wp_wc_order_product_lookup: {
-     create: Function;
-   };
-   wp_wc_order_stats: {
-     create: Function;
-   };
- }
  
  // Use the OrderCreateParams interface from services/order/create
    try {
      const body: OrderCreateBody = await request.json();
-     const {
-       customer,
-       products,
-       status = "wc-processing",
-       paymentMethod = "cod",
-       paymentMethodTitle = "Cash on delivery",
-       start_date, // Destructure start_date from body
-     } = body;
+     const { products, start_date } = body;
  
      if (!products || !Array.isArray(products) || products.length === 0) {
      }
  
-     // Calculate total amount from products
-     const totalAmount = products.reduce(
-       (total, product: ProductItem) => total + product.price * product.quantity,
-       0
-     );
- 
-     // Create order using Prisma transaction
-     const result = await prisma.$transaction(async (tx: PrismaTransaction) => {
-       // 1. Create the main order record
-       const order = await createOrderRecord({
-         tx,
-         customerId: customer?.id,
-         email: customer?.email,
-         status,
-         totalAmount,
-         paymentMethod,
-         paymentMethodTitle,
+     const result = await createOrder(
+       body,
+       {
          ipAddress: request.headers.get("x-forwarded-for") || "127.0.0.1",
          userAgent: request.headers.get("user-agent") || "",
-         startDate: start_date,
-       });
- 
-       // 2. Create billing address if customer info is provided
-       if (customer) {
-         await createBillingAddress({
-           tx,
-           customer,
-           orderId: order.id,
-         });
-       }
- 
-       // 3. Create operational data
-       await createOperationalData({
-         tx,
-         orderId: order.id,
-       });
- 
-       // Calculate total items for order stats
-       let totalItemsCount = 0;
- 
-       // 4. Create order items and handle bundles
-       for (const product of products) {
-         // Create order item
-         const orderItem = await createOrderItem({
-           tx,
-           orderId: order.id,
-           product,
-         });
- 
-         // Generate base order item meta
-         const baseItemMeta = generateOrderItemMeta({
-           orderItemId: orderItem.order_item_id,
-           product,
-         });
- 
-         // Add entry to wp_wc_order_product_lookup for main product
-         await createOrderProductLookup({
-           tx,
-           orderItemId: orderItem.order_item_id,
-           orderId: order.id,
-           product,
-           customer,
-         });
- 
-         totalItemsCount += product.quantity;
- 
-         // If this is a bundle product, add bundle-specific meta
-         if (product.isBundle && product.bundleItems) {
-           const bundleCartKey = Math.random().toString(36).substring(2, 15);
-           const bundledItemsKeys = product.bundleItems.map(() =>
-             Math.random().toString(36).substring(2, 15)
-           );
- 
-           // Add bundle meta
-           const bundleMeta = generateBundleProductMeta({
-             orderItemId: orderItem.order_item_id,
-             bundleCartKey,
-             bundledItemsKeys,
-           });
- 
-           baseItemMeta.push(...bundleMeta);
- 
-           // Create bundled items
-           for (const [index, bundleItem] of product.bundleItems.entries()) {
-             const bundledOrderItem = await tx.wp_woocommerce_order_items.create(
-               {
-                 data: {
-                   order_item_name: `Product #${bundleItem.product_id}`,
-                   order_item_type: "line_item",
-                   order_id: order.id,
-                 },
-               }
-             );
- 
-             // Add bundled item meta
-             await tx.wp_woocommerce_order_itemmeta.createMany({
-               data: [
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_product_id",
-                   meta_value: bundleItem.product_id.toString(),
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_variation_id",
-                   meta_value: "0",
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_qty",
-                   meta_value: bundleItem.quantity.toString(),
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_tax_class",
-                   meta_value: "",
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_line_subtotal",
-                   meta_value: "0",
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_line_subtotal_tax",
-                   meta_value: "0",
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_line_total",
-                   meta_value: "0",
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_line_tax",
-                   meta_value: "0",
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_line_tax_data",
-                   meta_value: 'a:2:{s:5:"total";a:0:{}s:8:"subtotal";a:0:{}}',
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_bundled_by",
-                   meta_value: bundleCartKey,
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_bundled_item_id",
-                   meta_value: (index + 1).toString(),
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_bundled_item_priced_individually",
-                   meta_value: "no",
-                 },
-                 {
-                   order_item_id: bundledOrderItem.order_item_id,
-                   meta_key: "_bundled_item_needs_shipping",
-                   meta_value: "yes",
-                 },
-               ],
-             });
- 
-             // Add entry to wp_wc_order_product_lookup for bundled item
-             await createOrderProductLookup({
-               tx,
-               orderItemId: bundledOrderItem.order_item_id,
-               orderId: order.id,
-               product: {
-                 product_id: bundleItem.product_id,
-                 quantity: bundleItem.quantity,
-                 price: 0, // Bundled items typically have 0 price
-               },
-               customer,
-             });
- 
-             totalItemsCount += bundleItem.quantity;
- 
-             // Update stock for bundled item
-             await tx.wp_wc_product_meta_lookup.upsert({
-               where: {
-                 product_id: BigInt(bundleItem.product_id),
-               },
-               create: {
-                 product_id: BigInt(bundleItem.product_id),
-                 stock_quantity: -bundleItem.quantity,
-                 total_sales: bundleItem.quantity,
-                 min_price: 0,
-                 max_price: 0,
-                 rating_count: 0,
-                 average_rating: 0,
-               },
-               update: {
-                 stock_quantity: {
-                   decrement: bundleItem.quantity,
-                 },
-                 total_sales: {
-                   increment: bundleItem.quantity,
-                 },
-               },
-             });
-           }
-         }
- 
-         // Create order item meta
-         await tx.wp_woocommerce_order_itemmeta.createMany({
-           data: baseItemMeta,
-         });
- 
-         // Update product stock if not a bundle
-         if (!product.isBundle) {
-           await updateProductStock({
-             tx,
-             product,
-           });
-         }
-       }
- 
-       // 5. Create order stats entry
-       try {
-         await tx.wp_wc_order_stats.create({
-           data: {
-             order_id: order.id,
-             parent_id: BigInt(0),
-             date_created: new Date(),
-             date_created_gmt: new Date(),
-             num_items_sold: totalItemsCount,
-             total_sales: totalAmount,
-             tax_total: 0,
-             shipping_total: 0,
-             net_total: totalAmount,
-             returning_customer: false,
-             status: status,
-             customer_id: customer?.id ? BigInt(customer.id) : BigInt(0),
-           },
-         });
-       } catch (error) {
-         console.warn("Failed to create order stats:", error);
-         // Continue processing as this is not critical
-       }
- 
-       return {
-         id: order.id.toString(),
-         number: `#ORD-${order.id.toString().padStart(3, "0")}`,
-         date: order.date_created_gmt?.toISOString(),
-         customer: customer
-           ? `${customer.firstName || ""} ${customer.lastName || ""}`
-           : "Guest",
-         status: order.status,
-         total: Number(order.total_amount) || 0,
-       };
-     });
+       },
+       prisma
+     );
  
      return NextResponse.json(result);
```

---

_**User**_

create smaller functions 

---

_**Assistant**_



---

Let me break down the large `createOrder` function into smaller, more focused functions. I'll also fix the export issue.

---

Cancelled

---

_**User**_

do it in the router itself for now

---

_**Assistant**_



---

Cancelled

---



---



---

